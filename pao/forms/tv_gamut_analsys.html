
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒ‰ì—­ë¶„ì„</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'vendor/bootstrap/5.3.3/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendor/bootstrap-icons/1.11.3/font/bootstrap-icons.css' %}">
    <script src="{% static 'vendor/plotly/plotly-3.0.1.min.js' %}"></script>
    <style>
        /* ìµœì†Œí•œì˜ ì»¤ìŠ¤í…€ CSSë§Œ ìœ ì§€ */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-badge {
            font-size: 11px;
            font-weight: 500;
        }
    </style>
</head>    
<body>
    <div class="container-fluid p-3" style="background-color: #f8f9fa;">
        <!-- í—¤ë” ì˜ì—­ -->
        <div class="card mb-4">
            <div class="card-body text-center" id="analysisHeader">
                <h2 class="card-title text-muted mb-3">
                    <i class="bi bi-palette me-2"></i>CIE1976 ìƒ‰ì—­ë¶„ì„
                </h2>
                <div class="alert alert-warning mb-0" id="analysisInfo">
                    <div class="text-center">
                        <div class="loading-spinner mb-3"></div>
                        <div>ë¶€ëª¨ ì°½ì—ì„œ ë°ì´í„°ë¥¼ ë°›ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                        <div class="small mt-1">Color Filterì™€ Line Factor ì„ íƒì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <span class="badge bg-warning text-dark status-badge" id="connectionStatus">
                            <i class="bi bi-clock me-1"></i>ì—°ê²° ëŒ€ê¸° ì¤‘
                        </span>
                        <span class="ms-3 small text-muted">
                            ì‹¤ì‹œê°„ ì—°ë™ | F5: ìƒˆë¡œê³ ì¹¨
                        </span>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="refreshData()">
                                <i class="bi bi-arrow-clockwise me-1"></i>ìƒˆë¡œê³ ì¹¨
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="window.close()">
                                <i class="bi bi-x-lg me-1"></i>ì°½ ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê·¸ë˜í”„ ì˜ì—­ -->
        <div class="card">
            <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 600px;">
                <div id="gamutGraph">
                    <div id="loadingMessage" class="text-center text-muted">
                        <div class="loading-spinner mb-3"></div>
                        <h5 class="mt-3">ìƒ‰ì—­ë¶„ì„ ì¤€ë¹„ ì¤‘</h5>
                        <p class="text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{% static 'vendor/bootstrap/5.3.3/bootstrap.bundle.min.js' %}"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentGamutData = null;
        let isWindowReady = false;
        let connectionStatus = 'waiting';

        // ì°½ ë¡œë“œ ì™„ë£Œ ì‹œ
        window.addEventListener('load', function() {
            isWindowReady = true;
            console.log('ìƒ‰ì—­ë¶„ì„ ì°½ ë¡œë“œ ì™„ë£Œ');
            
            // ë¶€ëª¨ ì°½ì— ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage({
                        type: 'gamutWindowReady'
                    }, '*');
                    updateConnectionStatus('connected');
                } catch (error) {
                    console.error('ë¶€ëª¨ì°½ í†µì‹  ì‹¤íŒ¨:', error);
                    updateConnectionStatus('error');
                }
            } else {
                updateConnectionStatus('no_parent');
            }
        });

        // ë¶€ëª¨ ì°½ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
        window.addEventListener('message', function(event) {
            
            if (event.data.type === 'updateGamutData') {
                currentGamutData = event.data.data;
                updateAnalysisInfo(
					currentGamutData.colorFilter, 
					currentGamutData.lineFactor,
					currentGamutData.colorFilterLabel, 
					currentGamutData.lineFactorLabel,
				);
                updateConnectionStatus('connected');
                
                if (isWindowReady) {
                    renderGamutChart();
                }
            }
        });

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
		function updateConnectionStatus(status) {
		    const statusElement = document.getElementById('connectionStatus');
		    
		    switch(status) {
		        case 'connected':
		            statusElement.className = 'badge bg-success text-white status-badge';
		            statusElement.innerHTML = '<i class="bi bi-check-circle me-1"></i>ì—°ê²°ë¨';
		            break;
		        case 'waiting':
		            statusElement.className = 'badge bg-warning text-dark status-badge';
		            statusElement.innerHTML = '<i class="bi bi-clock me-1"></i>ì—°ê²° ëŒ€ê¸° ì¤‘';
		            break;
		        case 'error':
		            statusElement.className = 'badge bg-danger text-white status-badge';
		            statusElement.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>ì—°ê²° ì˜¤ë¥˜';
		            break;
		        case 'no_parent':
		            statusElement.className = 'badge bg-secondary text-white status-badge';
		            statusElement.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>ë¶€ëª¨ì°½ ì—†ìŒ';
		            break;
		    }
		}

        // ë¶„ì„ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateAnalysisInfo(colorFilter, lineFactor, colorFilterLabel, lineFactorLabel) {
			const displayColorFilter = colorFilterLabel || colorFilter;
			const displayLineFactor = lineFactorLabel || lineFactor;
			
            document.title = `ìƒ‰ì—­ë¶„ì„ - ${displayColorFilter} Ã— ${displayLineFactor}`;
            
            const infoElement = document.getElementById('analysisInfo');
            infoElement.className = 'info';
            infoElement.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong><i class="bi bi-palette me-1"></i>Color Filter:</strong> ${displayColorFilter}
                    </div>
                    <div class="col-md-6">
                        <strong><i class="bi bi-graph-up me-1"></i>Line Factor:</strong> ${displayLineFactor}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}
                        </small>
                    </div>
                </div>
            `;
        }

        // ìƒ‰ì—­ë¶„ì„ ê·¸ë˜í”„ ë Œë”ë§
        function renderGamutChart() {
            if (!currentGamutData || !currentGamutData.gamutGraphData) {
                console.warn("ìƒ‰ì—­ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            console.log("ìƒ‰ì—­ë¶„ì„ ë Œë”ë§ ì‹œì‘");
            
            // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }
            
            const gamutData = currentGamutData.gamutGraphData;
            const traces = [];
            const cieData = gamutData.cie1976_gamut || [];
            
            // CIE1976 Gamut ê²½ê³„
            if (cieData.length > 0) {
                traces.push({
                    x: cieData.map(p => p[0]), 
                    y: cieData.map(p => p[1]),
                    mode: 'lines', 
                    name: 'CIE1976 Gamut',
                    line: { color: '#dee2e6', width: 2 },
                    hovertemplate: 'CIE1976 ê²½ê³„<br>u\': %{x:.3f}<br>v\': %{y:.3f}<extra></extra>'
                });
            }
            
            // ì°¸ì¡° ìƒ‰ê³µê°„ë“¤
            const colorMap = {
                'sRGB': '#28a745',
                'DCI-P3': '#ffc107', 
                'BT.2020': '#dc3545'
            };
            
            Object.entries(gamutData.ref_uv || {}).forEach(([name, coords]) => {
                if (coords && coords.length > 0) {
                    const closed = [...coords, coords[0]];
                    traces.push({
                        x: closed.map(p => p[0]), 
                        y: closed.map(p => p[1]),
                        mode: 'lines', 
                        name: name,
                        line: { 
                            color: colorMap[name] || '#6c757d',
                            width: 3 
                        },
                        hovertemplate: `${name}<br>u': %{x:.3f}<br>v': %{y:.3f}<extra></extra>`
                    });
                }
            });
            
            // ì‚¬ìš©ì ë°ì´í„°
            Object.entries(gamutData.user_uv || {}).forEach(([label, coords]) => {
                if (coords && coords.length > 0) {
                    const closed = [...coords, coords[0]];
                    traces.push({
                        x: closed.map(p => p[0]), 
                        y: closed.map(p => p[1]),
                        mode: 'lines+markers', 
                        name: label,
                        marker: { 
                            size: 10,
                            symbol: 'diamond',
                            line: { width: 2, color: 'white' }
                        },
                        line: { width: 4 },
                        hovertemplate: `${label}<br>u': %{x:.3f}<br>v': %{y:.3f}<extra></extra>`
                    });
                }
            });
            
            const layout = {
                title: {
                    text: '',
                    font: { size: 16 }
                },
                xaxis: { 
                    title: {
                        text: "u'",
                        font: { size: 14, family: 'Arial, sans-serif' }
                    },
                    range: [0, 0.7],
                    scaleanchor: 'y',
                    scaleratio: 1,
                    gridcolor: '#f8f9fa',
                    zerolinecolor: '#dee2e6'
                },
                yaxis: { 
                    title: {
                        text: "v'",
                        font: { size: 14, family: 'Arial, sans-serif' }
                    },
                    range: [0, 0.7],
                    constrain: 'domain',
                    gridcolor: '#f8f9fa',
                    zerolinecolor: '#dee2e6'
                },
                width: 750,
                height: 750,
                margin: { t: 40, b: 80, l: 80, r: 140 },
                showlegend: true,
                legend: {
                    x: 1.05,
                    y: 1,
                    xanchor: 'left',
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#dee2e6',
                    borderwidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };
            
            const config = {
                responsive: false,
                displayModeBar: true,
                modeBarButtonsToRemove: [
                    'pan2d', 'lasso2d', 'select2d', 'autoScale2d', 
                    'resetScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian'
                ],
                displaylogo: false,
                toImageButtonOptions: {
                    format: 'png',
                    filename: `gamut_analysis_${currentGamutData.colorFilter}_${currentGamutData.lineFactor}`,
                    height: 750,
                    width: 750,
                    scale: 2
                }
            };
            
            Plotly.newPlot('gamutGraph', traces, layout, config);
            console.log("ìƒ‰ì—­ë¶„ì„ ê·¸ë˜í”„ ë Œë”ë§ ì™„ë£Œ");
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function refreshData() {
            console.log("ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ë¨");
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage({
                        type: 'requestGamutData'
                    }, '*');
                    console.log("ë¶€ëª¨ì°½ì— ë°ì´í„° ìš”ì²­ ì „ì†¡");
                } catch (error) {
                    console.error('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:', error);
                    alert('ë¶€ëª¨ì°½ê³¼ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                console.log("ë¶€ëª¨ì°½ì´ ì—†ê±°ë‚˜ ë‹«í˜€ìˆìŒ");
                alert('ë¶€ëª¨ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì°½ ë‹«í ë•Œ ë¶€ëª¨ ì°½ì— ì•Œë¦¼
        window.addEventListener('beforeunload', function() {
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage({
                        type: 'gamutWindowClosed'
                    }, '*');
                } catch (error) {
                    console.error('ì°½ ë‹«í˜ ì•Œë¦¼ ì‹¤íŒ¨:', error);
                }
            }
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ìˆ˜ì •ëœ ë²„ì „)
        document.addEventListener('keydown', function(e) {
            console.log("í‚¤ ì…ë ¥:", e.key);
            
            if (e.key === 'Escape') {
                console.log("ESC í‚¤ ê°ì§€ë¨");
                e.preventDefault();
                focusParent();
            } else if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                console.log("ìƒˆë¡œê³ ì¹¨ í‚¤ ê°ì§€ë¨");
                e.preventDefault();
                refreshData();
            }
        });

        // ì—°ê²° ìƒíƒœ ì£¼ê¸°ì  í™•ì¸
        setInterval(function() {
            if (window.opener && window.opener.closed) {
                updateConnectionStatus('no_parent');
            }
        }, 5000);
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸
        console.log("í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ");
        console.log("ESC: ë¶€ëª¨ì°½ í¬ì»¤ìŠ¤, F5/Ctrl+R: ìƒˆë¡œê³ ì¹¨");
    </script>
</body>
</html>
